generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String   
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  favorites Favorite[]  
  addresses Address[]
  reviews   Review[]
}

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  imageUrl  String?  
  publicId  String? 
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  parentId  String?   // Üst kategorinin ID'si (Boşsa bu bir ana kategoridir)
  parent    Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")

  products  Product[] @relation("ProductCategories")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  price       Decimal  @db.Decimal(10,2)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  featured  Boolean  @default(false)
  
  complementaryId String?  
  complementary   Product? @relation("Complementary", fields: [complementaryId], references: [id]) // Bağlı olduğu ürün
  complementedBy  Product[] @relation("Complementary")
  
  images      ProductImage[]
  orderItems  OrderItem[]
  movements   StockMovement[]
  categories  Category[] @relation("ProductCategories")

  favoritedBy Favorite[]
  sizes      ProductSize[]     
  colors     ProductColor[]    
  attributes Json?
  reviews     Review[]
}

model ProductImage {
  id        String   @id @default(cuid())
  url       String
  alt       String?
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  publicId  String?  @unique

  color     ProductColor? @relation(fields: [colorId], references: [id], onDelete: SetNull)
  colorId   String?

  @@index([productId])
}

model Order {
  id         String      @id @default(cuid())
  orderNumber  Int?        @unique
  user       User        @relation(fields: [userId], references: [id])
  userId     String
  status     OrderStatus @default(PENDING)
  total      Decimal     @db.Decimal(10,2)

  cargoTrackingNumber String? 
  cargoCompany        String?

  shippingAddressId    String?
  shippingAddress      Address? @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])


  shippingName         String?
  shippingPhone        String?
  shippingCity         String?
  shippingDistrict     String?
  shippingNeighborhood String?
  shippingAddressLine  String?
  shippingPostalCode   String?
  customerNote         String?

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  items      OrderItem[]
}

model OrderItem {
  id        String   @id @default(cuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10,2)

  sizeId    String?
  size      ProductSize?   @relation("OrderItemSize", fields: [sizeId], references: [id], onDelete: SetNull)
  colorId   String?
  color     ProductColor?  @relation("OrderItemColor", fields: [colorId], references: [id], onDelete: SetNull)
  sizeLabel String?
  colorLabel String?

  @@index([orderId])
  @@index([productId])
  @@index([sizeId])
  @@index([colorId])
}

enum OrderStatus {
  PENDING           // Sepet aşaması
  AWAITING_PAYMENT  // Ödeme ekranında 
  PAID              // Ödeme alındı
  SHIPPED           // Kargolandı
  DELIVERED         // Teslim Edildi
  CANCELED          // İptal
}

model StockMovement {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  delta     Int
  note      String?
  createdAt DateTime @default(now())

  sizeId    String?
  size      ProductSize?  @relation("MovementSize", fields: [sizeId], references: [id], onDelete: Cascade)
  colorId   String?
  color     ProductColor? @relation("MovementColor", fields: [colorId], references: [id], onDelete: Cascade)

  @@index([productId, createdAt])
  @@index([sizeId, createdAt])
  @@index([colorId, createdAt])
}

model Favorite {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  createdAt DateTime @default(now())

  @@unique([userId, productId])    
  @@index([userId])
  @@index([productId])
}


model ProductSize {
  id        String   @id @default(cuid())
  label     String
  stock     Int      @default(0)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  orderItems OrderItem[]     @relation("OrderItemSize")
  movements  StockMovement[] @relation("MovementSize")

  @@unique([productId, label]) 
  @@index([productId])
}

model ProductColor {
  id        String   @id @default(cuid())
  label     String
  stock     Int      @default(0)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  // back-relations
  orderItems OrderItem[]     @relation("OrderItemColor")
  movements  StockMovement[] @relation("MovementColor")
  images     ProductImage[]  // bu renge atanmış ürün görselleri

  @@unique([productId, label])
  @@index([productId])
}

model Address {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String

  title        String   @default("Ev")    // Ev, İş, Aile vb.
  fullName     String
  phone        String
  city         String
  district     String
  neighborhood String?
  addressLine  String   // detay adres
  postalCode   String?

  isDefault    Boolean  @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders       Order[]  @relation("OrderShippingAddress")

  @@index([userId])
}

model Review {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  rating    Int      // 1–5
  comment   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])  // her kullanıcı ürünü 1 kez değerlendirebilsin
  @@index([productId])
  @@index([userId])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}